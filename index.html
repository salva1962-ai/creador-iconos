<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Iconos Pasteles Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        };
    </script>
    <link rel="apple-touch-icon" sizes="180x180" href="icon-192x192.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#e9d5ec">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Modo oscuro mejorado */
        .dark {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: #e2e8f0;
        }

        .dark .bg-white {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%) !important;
            color: #e2e8f0 !important;
        }

        .dark .text-gray-800,
        .dark .text-gray-700,
        .dark .text-gray-600 {
            color: #e2e8f0 !important;
        }

        .dark .bg-gray-50 {
            background-color: #2d3748 !important;
        }

        .dark .border-gray-200,
        .dark .border-gray-300 {
            border-color: #4a5568 !important;
        }

        .dark .border-pink-300 {
            border-color: #ed64a6 !important;
        }

        .dark .border-blue-300 {
            border-color: #63b3ed !important;
        }

        .dark .bg-pink-50 {
            background-color: rgba(237, 100, 166, 0.1) !important;
        }

        .dark .bg-blue-50 {
            background-color: rgba(99, 179, 237, 0.1) !important;
        }

        .dark .bg-pink-100,
        .dark .bg-blue-100,
        .dark .bg-gray-100 {
            background-color: #4a5568 !important;
        }

        .dark .text-red-500 {
            color: #fc8181 !important;
        }

        .dark .text-blue-700 {
            color: #63b3ed !important;
        }

        .dark .bg-yellow-400 {
            background-color: #f6e05e !important;
            color: #1a202c !important;
        }

        .dark .bg-orange-400 {
            background-color: #ed8936 !important;
            color: #1a202c !important;
        }

        .dark input[type="text"],
        .dark input[type="color"],
        .dark input[type="file"],
        .dark input[type="range"],
        .dark select {
            background-color: #4a5568 !important;
            border-color: #718096 !important;
            color: #e2e8f0 !important;
        }

        .dark input[type="text"]:focus,
        .dark select:focus {
            border-color: #ed64a6 !important;
            box-shadow: 0 0 0 3px rgba(237, 100, 166, 0.1) !important;
        }

        .dark button:hover {
            opacity: 0.9;
        }

        /* Bot√≥n de modo oscuro mejorado */
        .dark-mode-toggle {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(102, 126, 234, 0.3);
        }

        .dark .dark-mode-toggle {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 15px 0 rgba(245, 87, 108, 0.3);
        }

        .dark-mode-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(102, 126, 234, 0.4);
        }

        .dark .dark-mode-toggle:hover {
            box-shadow: 0 6px 20px 0 rgba(245, 87, 108, 0.4);
        }

        /* Animaci√≥n de preview hover */
        .preview-canvas {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .preview-canvas:hover {
            transform: scale(1.05) rotate(2deg);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        /* Animaci√≥n de loading */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Plantillas */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .template-item {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .template-item:hover {
            border-color: #ec4899;
            background-color: #fdf2f8;
            transform: translateY(-2px);
        }

        .dark .template-item {
            border-color: #4a5568;
            background-color: #2d3748;
        }

        .dark .template-item:hover {
            border-color: #ed64a6;
            background-color: rgba(237, 100, 166, 0.1);
        }

        /* Progress bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ec4899, #8b5cf6);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        // Funci√≥n para detectar preferencia del sistema
        const getSystemDarkMode = () => {
            if (typeof window !== 'undefined' && window.matchMedia) {
                return window.matchMedia('(prefers-color-scheme: dark)').matches;
            }
            return false;
        };

        // Funci√≥n para aplicar modo oscuro
        const applyDarkMode = (isDark) => {
            if (isDark) {
                document.documentElement.classList.add('dark');
                document.body.style.background = 'linear-gradient(135deg, #1a202c 0%, #2d3748 100%)';
            } else {
                document.documentElement.classList.remove('dark');
                document.body.style.background = 'linear-gradient(135deg, #fdf2f8 0%, #fae8ff 100%)';
            }
        };

        const PastelIconMaker = () => {
            // Estado del modo oscuro
            const [darkMode, setDarkMode] = useState(() => {
                const saved = localStorage.getItem('darkMode');
                return saved !== null ? JSON.parse(saved) : getSystemDarkMode();
            });

            // Estados principales
            const canvasRef = useRef(null);
            const [uploadedImage, setUploadedImage] = useState(null);
            const [selectedColor, setSelectedColor] = useState('#FFB3BA');
            const [selectedShape, setSelectedShape] = useState('circle');
            const [iconSize, setIconSize] = useState(512);
            const [backgroundColor, setBackgroundColor] = useState('#FFFFFF');
            const [gradientEnabled, setGradientEnabled] = useState(false);
            const [secondaryColor, setSecondaryColor] = useState('#BAFFC9');
            const [shadowEnabled, setShadowEnabled] = useState(true);
            const [borderEnabled, setBorderEnabled] = useState(false);
            const [iconText, setIconText] = useState('');
            const [fontSize, setFontSize] = useState(200);
            const [colorPalette, setColorPalette] = useState('pastel');
            const [showColorOverImage, setShowColorOverImage] = useState(true);
            const [imageOnTop, setImageOnTop] = useState(false);
            const [imageError, setImageError] = useState("");

            // Estados para nuevas caracter√≠sticas
            const [isExporting, setIsExporting] = useState(false);
            const [exportProgress, setExportProgress] = useState(0);
            const [showTemplates, setShowTemplates] = useState(false);
            const [selectedTemplate, setSelectedTemplate] = useState(null);
            const [showSymbols, setShowSymbols] = useState(false);

            // Plantillas predefinidas
            const templates = [
                {
                    id: 'app',
                    name: 'App M√≥vil',
                    emoji: 'üì±',
                    config: {
                        selectedColor: '#4F46E5',
                        selectedShape: 'rounded-square',
                        backgroundColor: '#FFFFFF',
                        shadowEnabled: true,
                        borderEnabled: false,
                        gradientEnabled: true,
                        secondaryColor: '#7C3AED'
                    }
                },
                {
                    id: 'web',
                    name: 'Web App',
                    emoji: 'üåê',
                    config: {
                        selectedColor: '#059669',
                        selectedShape: 'circle',
                        backgroundColor: '#F0FDF4',
                        shadowEnabled: true,
                        borderEnabled: true,
                        gradientEnabled: false
                    }
                },
                {
                    id: 'game',
                    name: 'Juego',
                    emoji: 'üéÆ',
                    config: {
                        selectedColor: '#DC2626',
                        selectedShape: 'star',
                        backgroundColor: '#FEF2F2',
                        shadowEnabled: true,
                        borderEnabled: false,
                        gradientEnabled: true,
                        secondaryColor: '#F59E0B'
                    }
                },
                {
                    id: 'social',
                    name: 'Social',
                    emoji: 'üí¨',
                    config: {
                        selectedColor: '#EC4899',
                        selectedShape: 'heart',
                        backgroundColor: '#FDF2F8',
                        shadowEnabled: true,
                        borderEnabled: false,
                        gradientEnabled: true,
                        secondaryColor: '#8B5CF6'
                    }
                },
                {
                    id: 'productivity',
                    name: 'Productividad',
                    emoji: '‚ö°',
                    config: {
                        selectedColor: '#0891B2',
                        selectedShape: 'hexagon',
                        backgroundColor: '#F0F9FF',
                        shadowEnabled: true,
                        borderEnabled: true,
                        gradientEnabled: false
                    }
                },
                {
                    id: 'education',
                    name: 'Educaci√≥n',
                    emoji: 'üìö',
                    config: {
                        selectedColor: '#7C2D12',
                        selectedShape: 'triangle',
                        backgroundColor: '#FEF7ED',
                        shadowEnabled: true,
                        borderEnabled: false,
                        gradientEnabled: true,
                        secondaryColor: '#EA580C'
                    }
                }
            ];

            // S√≠mbolos precargados organizados por categor√≠as
            const symbolCategories = {
                'Letras': ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'],
                'N√∫meros': ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '#', '@'],
                'Tecnolog√≠a': ['üíª', 'üì±', '‚åö', 'üñ•Ô∏è', '‚å®Ô∏è', 'üñ±Ô∏è', 'üíæ', 'üíø', 'üìÄ', 'üñ®Ô∏è', 'üì°', 'üîå', 'üîã', 'ü™´', 'üí°', 'üî¶'],
                'Comunicaci√≥n': ['üìß', '‚úâÔ∏è', 'üì®', 'üì©', 'üì§', 'üì•', 'üìÆ', 'üì¨', 'üì≠', 'üì™', 'üì´', 'üìû', '‚òéÔ∏è', 'üìü', 'üì†', 'üì°'],
                'Emociones': ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™'],
                'Deportes': ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'ü•è', 'üé±', 'ü™Ä', 'üèì', 'üè∏', 'üèí', 'üèë', 'ü•ç', 'üèè', 'ü™É', 'ü•Ö', '‚õ≥', 'üèπ'],
                'Animales': ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üêî', 'üêß', 'üê¶', 'üê§', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á', 'üê∫'],
                'Comida': ['üçé', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'ü´ê', 'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'üçÜ', 'ü•ë', 'ü•¶', 'ü•¨', 'ü•í', 'üå∂Ô∏è', 'ü´ë', 'üåΩ'],
                'Naturaleza': ['üå±', 'üåø', '‚òòÔ∏è', 'üçÄ', 'üéã', 'üéç', 'üçÉ', 'üçÇ', 'üçÅ', 'üåæ', 'üå∫', 'üåª', 'üåπ', 'ü•Ä', 'üå∑', 'üå∏', 'üíê', 'üèµÔ∏è', 'üåº', 'üå≤', 'üå≥', 'üå¥', 'üåµ'],
                'Transporte': ['üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê', 'üõª', 'üöö', 'üöõ', 'üöú', 'üèçÔ∏è', 'üõµ', 'üö≤', 'üõ¥', '‚úàÔ∏è', 'üöÄ', 'üõ∏', 'üöÅ', '‚õµ', 'üö§'],
                'S√≠mbolos': ['‚ù§Ô∏è', 'üíô', 'üíö', 'üíõ', 'üß°', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', '‚≠ê', '‚ú®', 'üåü', 'üí´', '‚ö°', 'üî•'],
                'Objetos': ['üé®', 'üñºÔ∏è', 'üé≠', 'üé™', 'üé¨', 'üé§', 'üéß', 'üéº', 'üéπ', 'ü•Å', 'ü™ò', 'üé∑', 'üé∫', 'ü™ó', 'üé∏', 'ü™ï', 'üéª', 'üé≤', '‚ôüÔ∏è', 'üéØ', 'üé≥', 'üéÆ', 'üé∞', 'üß©'],
                'Oficina': ['üìù', '‚úèÔ∏è', '‚úíÔ∏è', 'üñäÔ∏è', 'üñãÔ∏è', 'üñçÔ∏è', 'üìï', 'üìó', 'üìò', 'üìô', 'üìì', 'üìî', 'üìí', 'üìö', 'üìñ', 'üóÇÔ∏è', 'üìÇ', 'üìÅ', 'üìã', 'üìä', 'üìà', 'üìâ', 'üóíÔ∏è', 'üìå']
            };

            const [selectedCategory, setSelectedCategory] = useState('Emociones');

            // Paletas de colores
            const pastelColors = [
                '#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF',
                '#D4BAFF', '#FFB3D9', '#FFC9B3', '#B3FFB3', '#B3E5FF',
                '#E1B3FF', '#FFE1B3', '#C9FFB3', '#B3D9FF', '#F0B3FF',
                '#FFD1DC', '#FFEAA7', '#DDA0DD', '#98FB98', '#87CEEB',
                '#F5DEB3', '#FFE4E1', '#E0FFFF', '#F0F8FF', '#FFF8DC'
            ];

            const standardColors = [
                '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF',
                '#000000', '#FFFFFF', '#808080', '#800000', '#008000', '#000080',
                '#808000', '#800080', '#008080', '#C0C0C0', '#FFA500', '#A52A2A',
                '#8A2BE2', '#5F9EA0', '#D2691E', '#DC143C', '#006400', '#B8860B'
            ];

            const shapes = [
                { id: 'circle', name: 'C√≠rculo' },
                { id: 'square', name: 'Cuadrado' },
                { id: 'rounded-square', name: 'Cuadrado Redondeado' },
                { id: 'triangle', name: 'Tri√°ngulo' },
                { id: 'star', name: 'Estrella' },
                { id: 'heart', name: 'Coraz√≥n' },
                { id: 'hexagon', name: 'Hex√°gono' }
            ];

            const iconSizes = [
                { size: 192, name: '192x192 (Android)' },
                { size: 512, name: '512x512 (PWA)' },
                { size: 180, name: '180x180 (iOS)' },
                { size: 1024, name: '1024x1024 (Alta resoluci√≥n)' }
            ];

            // Tama√±os para batch export
            const batchSizes = [16, 32, 48, 96, 144, 192, 256, 512, 1024];

            // Efecto para el modo oscuro
            useEffect(() => {
                applyDarkMode(darkMode);
                localStorage.setItem('darkMode', JSON.stringify(darkMode));
            }, [darkMode]);

            // Escuchar cambios del sistema
            useEffect(() => {
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                const handleChange = () => {
                    if (localStorage.getItem('darkMode') === null) {
                        setDarkMode(mediaQuery.matches);
                    }
                };
                mediaQuery.addEventListener('change', handleChange);
                return () => mediaQuery.removeEventListener('change', handleChange);
            }, []);

            // Funci√≥n para aplicar plantilla
            const applyTemplate = (template) => {
                const config = template.config;
                setSelectedColor(config.selectedColor);
                setSelectedShape(config.selectedShape);
                setBackgroundColor(config.backgroundColor);
                setShadowEnabled(config.shadowEnabled);
                setBorderEnabled(config.borderEnabled);
                setGradientEnabled(config.gradientEnabled || false);
                if (config.secondaryColor) {
                    setSecondaryColor(config.secondaryColor);
                }
                setSelectedTemplate(template.id);
                setShowTemplates(false);
            };

            // Funci√≥n para dibujar formas y texto
            const drawShapesAndText = useCallback((ctx, size) => {
                if (shadowEnabled) {
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
                    ctx.shadowBlur = size * 0.05;
                    ctx.shadowOffsetX = size * 0.02;
                    ctx.shadowOffsetY = size * 0.02;
                }

                let fillStyle;
                if (gradientEnabled) {
                    const gradient = ctx.createLinearGradient(0, 0, size, size);
                    gradient.addColorStop(0, selectedColor);
                    gradient.addColorStop(1, secondaryColor);
                    fillStyle = gradient;
                } else {
                    fillStyle = selectedColor;
                }

                ctx.fillStyle = fillStyle;
                const center = size / 2;
                const shapeSize = size * 0.7;

                ctx.beginPath();
                switch (selectedShape) {
                    case 'circle':
                        ctx.arc(center, center, shapeSize / 2, 0, 2 * Math.PI);
                        break;
                    case 'square':
                        const squareSize = shapeSize;
                        ctx.rect(center - squareSize/2, center - squareSize/2, squareSize, squareSize);
                        break;
                    case 'rounded-square':
                        const rsSize = shapeSize;
                        const radius = rsSize * 0.2;
                        const x = center - rsSize/2;
                        const y = center - rsSize/2;
                        ctx.moveTo(x + radius, y);
                        ctx.lineTo(x + rsSize - radius, y);
                        ctx.quadraticCurveTo(x + rsSize, y, x + rsSize, y + radius);
                        ctx.lineTo(x + rsSize, y + rsSize - radius);
                        ctx.quadraticCurveTo(x + rsSize, y + rsSize, x + rsSize - radius, y + rsSize);
                        ctx.lineTo(x + radius, y + rsSize);
                        ctx.quadraticCurveTo(x, y + rsSize, x, y + rsSize - radius);
                        ctx.lineTo(x, y + radius);
                        ctx.quadraticCurveTo(x, y, x + radius, y);
                        break;
                    case 'triangle':
                        const triSize = shapeSize;
                        ctx.moveTo(center, center - triSize/2);
                        ctx.lineTo(center - triSize/2, center + triSize/2);
                        ctx.lineTo(center + triSize/2, center + triSize/2);
                        ctx.closePath();
                        break;
                    case 'star':
                        const starSize = shapeSize / 2;
                        const spikes = 5;
                        const outerRadius = starSize;
                        const innerRadius = starSize * 0.4;
                        for (let i = 0; i < spikes * 2; i++) {
                            const radius = i % 2 === 0 ? outerRadius : innerRadius;
                            const angle = (i * Math.PI) / spikes;
                            const x = center + Math.cos(angle - Math.PI/2) * radius;
                            const y = center + Math.sin(angle - Math.PI/2) * radius;
                            if (i === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        }
                        ctx.closePath();
                        break;
                    case 'heart':
                        const heartSize = shapeSize * 0.4;
                        ctx.moveTo(center, center + heartSize/4);
                        ctx.bezierCurveTo(center, center - heartSize/4, center - heartSize, center - heartSize/4, center - heartSize, center + heartSize/8);
                        ctx.bezierCurveTo(center - heartSize, center + heartSize/2, center, center + heartSize, center, center + heartSize);
                        ctx.bezierCurveTo(center, center + heartSize, center + heartSize, center + heartSize/2, center + heartSize, center + heartSize/8);
                        ctx.bezierCurveTo(center + heartSize, center - heartSize/4, center, center - heartSize/4, center, center + heartSize/4);
                        break;
                    case 'hexagon':
                        const hexSize = shapeSize / 2;
                        const sides = 6;
                        for (let i = 0; i < sides; i++) {
                            const angle = (i * 2 * Math.PI) / sides;
                            const x = center + Math.cos(angle) * hexSize;
                            const y = center + Math.sin(angle) * hexSize;
                            if (i === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        }
                        ctx.closePath();
                        break;
                }
                ctx.fill();

                if (borderEnabled) {
                    ctx.shadowColor = 'transparent';
                    ctx.strokeStyle = '#FFFFFF';
                    ctx.lineWidth = size * 0.02;
                    ctx.stroke();
                }

                if (iconText.trim()) {
                    ctx.shadowColor = 'transparent';
                    ctx.fillStyle = '#FFFFFF';
                    const textSize = Math.max(size * 0.1, fontSize * (size / 512));
                    ctx.font = `bold ${textSize}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                    ctx.lineWidth = textSize * 0.05;
                    ctx.strokeText(iconText, center, center);
                    ctx.fillText(iconText, center, center);
                }
            }, [selectedColor, selectedShape, backgroundColor, gradientEnabled, secondaryColor, shadowEnabled, borderEnabled, iconText, fontSize]);

            // Funci√≥n para dibujar en un canvas espec√≠fico
            const drawIconOnCanvas = useCallback((canvas, size) => {
                const ctx = canvas.getContext('2d');
                canvas.width = size;
                canvas.height = size;
                ctx.clearRect(0, 0, size, size);

                if (uploadedImage && !showColorOverImage) {
                    ctx.clearRect(0, 0, size, size);
                    if (imageOnTop) {
                        drawShapesAndText(ctx, size);
                        const img = new Image();
                        img.src = uploadedImage;
                        img.onload = function() {
                            const imgSize = size * 0.7;
                            ctx.drawImage(img, (size - imgSize) / 2, (size - imgSize) / 2, imgSize, imgSize);
                        };
                    } else {
                        const img = new Image();
                        img.src = uploadedImage;
                        img.onload = function() {
                            const imgSize = size * 0.7;
                            ctx.drawImage(img, (size - imgSize) / 2, (size - imgSize) / 2, imgSize, imgSize);
                        };
                    }
                    return;
                } else {
                    ctx.fillStyle = backgroundColor;
                    ctx.fillRect(0, 0, size, size);
                    
                    if (uploadedImage && imageOnTop) {
                        drawShapesAndText(ctx, size);
                        const img = new Image();
                        img.src = uploadedImage;
                        img.onload = function() {
                            const imgSize = size * 0.7;
                            ctx.drawImage(img, (size - imgSize) / 2, (size - imgSize) / 2, imgSize, imgSize);
                        };
                        return;
                    } else if (uploadedImage && !imageOnTop) {
                        const img = new Image();
                        img.src = uploadedImage;
                        img.onload = function() {
                            const imgSize = size * 0.7;
                            ctx.drawImage(img, (size - imgSize) / 2, (size - imgSize) / 2, imgSize, imgSize);
                            drawShapesAndText(ctx, size);
                        };
                        return;
                    }
                }
                
                drawShapesAndText(ctx, size);
            }, [uploadedImage, showColorOverImage, imageOnTop, backgroundColor, drawShapesAndText]);

            // Funci√≥n principal para dibujar el icono
            const drawIcon = useCallback(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                drawIconOnCanvas(canvas, iconSize);
            }, [drawIconOnCanvas, iconSize]);

            // Efecto para redibujar cuando cambien las propiedades
            useEffect(() => {
                drawIcon();
            }, [drawIcon]);

            // Funci√≥n de batch export mejorada
            const batchExport = async () => {
                setIsExporting(true);
                setExportProgress(0);
                
                try {
                    const zip = new JSZip();
                    const total = batchSizes.length;
                    
                    for (let i = 0; i < batchSizes.length; i++) {
                        const size = batchSizes[i];
                        const canvas = document.createElement('canvas');
                        
                        // Dibujar en el canvas temporal
                        drawIconOnCanvas(canvas, size);
                        
                        // Esperar un poco para que se dibuje
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        // Convertir a blob
                        const blob = await new Promise(resolve => {
                            canvas.toBlob(resolve, 'image/png');
                        });
                        
                        // A√±adir al zip
                        zip.file(`icon-${size}x${size}.png`, blob);
                        
                        // Actualizar progreso
                        setExportProgress(Math.round(((i + 1) / total) * 100));
                    }
                    
                    // Generar y descargar el zip
                    const zipBlob = await zip.generateAsync({ type: 'blob' });
                    const url = URL.createObjectURL(zipBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'icons-batch-export.zip';
                    link.click();
                    
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Error en batch export:', error);
                    alert('Error al exportar iconos en lote');
                } finally {
                    setIsExporting(false);
                    setExportProgress(0);
                }
            };

            // Funciones de utilidad existentes
            const downloadIcon = () => {
                const canvas = canvasRef.current;
                const link = document.createElement('a');
                link.download = `icon-${iconSize}x${iconSize}.png`;
                link.href = canvas.toDataURL();
                link.click();
            };

            const downloadFavicon = () => {
                const canvas = canvasRef.current;
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 48;
                tempCanvas.height = 48;
                const ctx = tempCanvas.getContext('2d');
                ctx.drawImage(canvas, 0, 0, 48, 48);
                
                tempCanvas.toBlob((blob) => {
                    const link = document.createElement('a');
                    link.download = 'favicon.ico';
                    link.href = URL.createObjectURL(blob);
                    link.click();
                }, 'image/png');
            };

            const copyToClipboard = async () => {
                const canvas = canvasRef.current;
                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        alert('¬°Icono copiado al portapapeles!');
                    } catch (err) {
                        console.error('Error al copiar:', err);
                        alert('Error al copiar al portapapeles');
                    }
                });
            };

            const resetSettings = () => {
                setSelectedColor('#FFB3BA');
                setSelectedShape('circle');
                setBackgroundColor('#FFFFFF');
                setGradientEnabled(false);
                setSecondaryColor('#BAFFC9');
                setShadowEnabled(true);
                setBorderEnabled(false);
                setIconText('');
                setFontSize(200);
                setUploadedImage(null);
                setShowColorOverImage(true);
                setImageOnTop(false);
                setColorPalette('pastel');
                setImageError('');
                setSelectedTemplate(null);
            };

            const handleImageUpload = (e) => {
                setImageError("");
                const file = e.target.files[0];
                if (file) {
                    const maxFileSize = 5 * 1024 * 1024; // 5MB
                    if (file.size > maxFileSize) {
                        setImageError("La imagen es demasiado grande. M√°ximo 5MB.");
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const img = new Image();
                        img.onload = () => {
                            setUploadedImage(ev.target.result);
                        };
                        img.onerror = () => {
                            setImageError("No se pudo cargar la imagen. Usa PNG, JPG, GIF o SVG v√°lidos.");
                        };
                        img.src = ev.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            // Render del componente
            return (
                <div className={`min-h-screen transition-all duration-300 p-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                    {/* Bot√≥n de modo oscuro mejorado */}
                    <button
                        className="dark-mode-toggle fixed top-4 right-4 z-50"
                        onClick={() => setDarkMode(!darkMode)}
                        title={darkMode ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro'}
                    >
                        {darkMode ? '‚òÄÔ∏è' : 'üåô'}
                    </button>

                    <div className="max-w-7xl mx-auto">
                        {/* T√≠tulo */}
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-bold mb-2 flex items-center justify-center gap-3">
                                üé® Creador de Iconos Pasteles Pro
                            </h1>
                            <p className={`${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                                Dise√±a iconos hermosos para tus aplicaciones y PWAs con plantillas y exportaci√≥n en lote
                            </p>
                        </div>

                        <div className="grid lg:grid-cols-3 gap-8">
                            {/* Panel de Control */}
                            <div className="lg:col-span-2 space-y-6">
                                {/* Plantillas Predefinidas */}
                                <div className="bg-white rounded-2xl p-6 shadow-lg">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-lg font-semibold">üéØ Plantillas Predefinidas</h3>
                                        <button
                                            onClick={() => setShowTemplates(!showTemplates)}
                                            className="px-3 py-1 text-sm bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors"
                                        >
                                            {showTemplates ? 'Ocultar' : 'Mostrar'}
                                        </button>
                                    </div>
                                    
                                    {showTemplates && (
                                        <div className="template-grid">
                                            {templates.map((template) => (
                                                <div
                                                    key={template.id}
                                                    className={`template-item ${selectedTemplate === template.id ? 'border-pink-500 bg-pink-50' : ''}`}
                                                    onClick={() => applyTemplate(template)}
                                                >
                                                    <div className="text-2xl mb-2">{template.emoji}</div>
                                                    <div className="text-xs font-medium">{template.name}</div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {/* Paleta de Colores */}
                                <div className="bg-white rounded-2xl p-6 shadow-lg">
                                    <h3 className="text-lg font-semibold mb-4">üé® Paleta de Colores</h3>
                                    
                                    {/* Selector de paleta */}
                                    <div className="flex gap-4 mb-4">
                                        <button
                                            className={`px-4 py-2 rounded-lg border transition-colors ${
                                                colorPalette === 'pastel' 
                                                    ? 'bg-pink-100 border-pink-300 text-pink-700' 
                                                    : 'bg-gray-100 border-gray-300'
                                            }`}
                                            onClick={() => setColorPalette('pastel')}
                                        >
                                            Pasteles
                                        </button>
                                        <button
                                            className={`px-4 py-2 rounded-lg border transition-colors ${
                                                colorPalette === 'standard' 
                                                    ? 'bg-blue-100 border-blue-300 text-blue-700' 
                                                    : 'bg-gray-100 border-gray-300'
                                            }`}
                                            onClick={() => setColorPalette('standard')}
                                        >
                                            Est√°ndar
                                        </button>
                                    </div>

                                    {/* Grid de colores */}
                                    <div className="grid grid-cols-10 gap-2 mb-4">
                                        {(colorPalette === 'pastel' ? pastelColors : standardColors).map((color) => (
                                            <button
                                                key={color}
                                                className={`w-8 h-8 rounded-lg border-2 transition-all hover:scale-110 ${
                                                    selectedColor === color ? 'border-gray-400 ring-2 ring-gray-300' : 'border-gray-200'
                                                }`}
                                                style={{ backgroundColor: color }}
                                                onClick={() => setSelectedColor(color)}
                                                title={color}
                                            />
                                        ))}
                                    </div>

                                    {/* Gradiente */}
                                    <div className="flex items-center gap-4 mb-4">
                                        <label className="flex items-center gap-2">
                                            <input
                                                type="checkbox"
                                                checked={gradientEnabled}
                                                onChange={(e) => setGradientEnabled(e.target.checked)}
                                                className="rounded"
                                            />
                                            <span className="text-sm">Gradiente</span>
                                        </label>
                                        
                                        {gradientEnabled && (
                                            <div className="grid grid-cols-10 gap-1">
                                                {(colorPalette === 'pastel' ? pastelColors : standardColors).map((color) => (
                                                    <button
                                                        key={color}
                                                        className={`w-6 h-6 rounded border ${
                                                            secondaryColor === color ? 'border-gray-400 ring-1' : 'border-gray-200'
                                                        }`}
                                                        style={{ backgroundColor: color }}
                                                        onClick={() => setSecondaryColor(color)}
                                                        title={`Segundo color: ${color}`}
                                                    />
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    {/* Subida de imagen */}
                                    <div className="mt-4">
                                        <label className="block text-sm font-medium mb-2">üìÅ Subir imagen</label>
                                        <input
                                            type="file"
                                            accept="image/*"
                                            onChange={handleImageUpload}
                                            className="w-full text-sm"
                                        />
                                        {imageError && (
                                            <p className="mt-2 text-xs text-red-500">{imageError}</p>
                                        )}
                                        
                                        {uploadedImage && (
                                            <div className="mt-4 flex flex-wrap items-center gap-4">
                                                <label className="flex items-center gap-2">
                                                    <input
                                                        type="checkbox"
                                                        checked={showColorOverImage}
                                                        onChange={(e) => setShowColorOverImage(e.target.checked)}
                                                    />
                                                    <span className="text-sm">Mostrar color sobre imagen</span>
                                                </label>
                                                <label className="flex items-center gap-2">
                                                    <input
                                                        type="checkbox"
                                                        checked={imageOnTop}
                                                        onChange={(e) => setImageOnTop(e.target.checked)}
                                                    />
                                                    <span className="text-sm">Imagen al frente</span>
                                                </label>
                                                <button
                                                    onClick={() => setUploadedImage(null)}
                                                    className="text-xs text-red-500 underline hover:text-red-700"
                                                >
                                                    Quitar imagen
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Formas */}
                                <div className="bg-white rounded-2xl p-6 shadow-lg">
                                    <h3 className="text-lg font-semibold mb-4">üî∂ Formas</h3>
                                    <div className="grid grid-cols-4 gap-3">
                                        {shapes.map((shape) => (
                                            <button
                                                key={shape.id}
                                                className={`p-4 rounded-xl border-2 transition-all hover:scale-105 ${
                                                    selectedShape === shape.id
                                                        ? 'border-pink-300 bg-pink-50'
                                                        : 'border-gray-200 hover:border-gray-300'
                                                }`}
                                                onClick={() => setSelectedShape(shape.id)}
                                            >
                                                <span className="text-xs">{shape.name}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Configuraciones */}
                                <div className="bg-white rounded-2xl p-6 shadow-lg">
                                    <h3 className="text-lg font-semibold mb-4">‚öôÔ∏è Configuraciones</h3>
                                    
                                    <div className="grid md:grid-cols-2 gap-6">
                                        <div>
                                            <label className="block text-sm font-medium mb-2">üìè Tama√±o del Icono</label>
                                            <select
                                                value={iconSize}
                                                onChange={(e) => setIconSize(Number(e.target.value))}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-300 focus:border-transparent"
                                            >
                                                {iconSizes.map((size) => (
                                                    <option key={size.size} value={size.size}>
                                                        {size.name}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium mb-2">üé® Color de Fondo</label>
                                            <input
                                                type="color"
                                                value={backgroundColor}
                                                onChange={(e) => setBackgroundColor(e.target.value)}
                                                className="w-full h-12 border rounded-lg cursor-pointer"
                                            />
                                        </div>
                                        
                                        <div className="md:col-span-2">
                                            <div className="flex items-center justify-between mb-2">
                                                <label className="block text-sm font-medium">‚úèÔ∏è Texto del Icono</label>
                                                <button
                                                    onClick={() => setShowSymbols(!showSymbols)}
                                                    className="px-3 py-1 text-xs bg-pink-100 text-pink-700 rounded-lg hover:bg-pink-200 transition-colors"
                                                >
                                                    {showSymbols ? 'Ocultar s√≠mbolos' : 'Mostrar s√≠mbolos'}
                                                </button>
                                            </div>
                                            <input
                                                type="text"
                                                value={iconText}
                                                onChange={(e) => setIconText(e.target.value)}
                                                placeholder="Ej: A, üöÄ, etc."
                                                maxLength="3"
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-300 focus:border-transparent"
                                            />
                                            
                                            {/* Panel de s√≠mbolos */}
                                            {showSymbols && (
                                                <div className="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                                    {/* Selector de categor√≠as */}
                                                    <div className="flex flex-wrap gap-2 mb-4">
                                                        {Object.keys(symbolCategories).map((category) => (
                                                            <button
                                                                key={category}
                                                                onClick={() => setSelectedCategory(category)}
                                                                className={`px-3 py-1 text-xs rounded-lg transition-colors ${
                                                                    selectedCategory === category
                                                                        ? 'bg-pink-500 text-white'
                                                                        : 'bg-white text-gray-700 hover:bg-pink-100'
                                                                }`}
                                                            >
                                                                {category}
                                                            </button>
                                                        ))}
                                                    </div>
                                                    
                                                    {/* Grid de s√≠mbolos */}
                                                    <div className="grid grid-cols-8 gap-2 max-h-48 overflow-y-auto p-2">
                                                        {symbolCategories[selectedCategory].map((symbol, index) => (
                                                            <button
                                                                key={index}
                                                                onClick={() => setIconText(symbol)}
                                                                className="w-10 h-10 flex items-center justify-center text-xl rounded-lg hover:bg-pink-100 transition-all hover:scale-110 border border-gray-200"
                                                                title={`Usar ${symbol}`}
                                                            >
                                                                {symbol}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium mb-2">
                                                üìù Tama√±o del Texto: {fontSize}px
                                            </label>
                                            <input
                                                type="range"
                                                min="50"
                                                max="400"
                                                value={fontSize}
                                                onChange={(e) => setFontSize(Number(e.target.value))}
                                                className="w-full"
                                            />
                                        </div>
                                    </div>

                                    <div className="flex flex-wrap gap-4 mt-6">
                                        <label className="flex items-center gap-2">
                                            <input
                                                type="checkbox"
                                                checked={shadowEnabled}
                                                onChange={(e) => setShadowEnabled(e.target.checked)}
                                                className="rounded"
                                            />
                                            <span className="text-sm">üå´Ô∏è Sombra</span>
                                        </label>
                                        <label className="flex items-center gap-2">
                                            <input
                                                type="checkbox"
                                                checked={borderEnabled}
                                                onChange={(e) => setBorderEnabled(e.target.checked)}
                                                className="rounded"
                                            />
                                            <span className="text-sm">üî≥ Borde</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            {/* Vista Previa y Acciones */}
                            <div className="space-y-6">
                                {/* Vista previa */}
                                <div className="bg-white rounded-2xl p-6 shadow-lg">
                                    <h3 className="text-lg font-semibold mb-4">üëÅÔ∏è Vista Previa</h3>
                                    <div className="flex flex-col items-center mb-6">
                                        <div className="p-4 bg-gray-50 rounded-xl">
                                            <canvas
                                                ref={canvasRef}
                                                className="preview-canvas max-w-full h-auto border border-gray-200 rounded-lg shadow-sm"
                                                style={{ width: '200px', height: '200px' }}
                                            />
                                        </div>
                                    </div>

                                    {/* Botones de acci√≥n */}
                                    <div className="space-y-3">
                                        <button
                                            onClick={downloadIcon}
                                            className="w-full bg-gradient-to-r from-pink-400 to-purple-400 text-white py-3 px-6 rounded-xl font-medium hover:from-pink-500 hover:to-purple-500 transition-all flex items-center justify-center gap-2"
                                        >
                                            üì• Descargar PNG
                                        </button>
                                        
                                        <button
                                            onClick={batchExport}
                                            disabled={isExporting}
                                            className="w-full bg-gradient-to-r from-emerald-400 to-cyan-400 text-white py-3 px-6 rounded-xl font-medium hover:from-emerald-500 hover:to-cyan-500 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            {isExporting ? (
                                                <>
                                                    <div className="loading-spinner"></div>
                                                    Exportando... {exportProgress}%
                                                </>
                                            ) : (
                                                <>üì¶ Batch Export (ZIP)</>
                                            )}
                                        </button>

                                        {isExporting && (
                                            <div className="progress-bar">
                                                <div 
                                                    className="progress-fill"
                                                    style={{ width: `${exportProgress}%` }}
                                                ></div>
                                            </div>
                                        )}
                                        
                                        <button
                                            onClick={downloadFavicon}
                                            className="w-full bg-gradient-to-r from-yellow-400 to-orange-400 text-white py-3 px-6 rounded-xl font-medium hover:from-yellow-500 hover:to-orange-500 transition-all flex items-center justify-center gap-2"
                                        >
                                            üåê Descargar Favicon (.ico)
                                        </button>
                                        <button
                                            onClick={copyToClipboard}
                                            className="w-full bg-gradient-to-r from-blue-400 to-cyan-400 text-white py-3 px-6 rounded-xl font-medium hover:from-blue-500 hover:to-cyan-500 transition-all flex items-center justify-center gap-2"
                                        >
                                            üìã Copiar al Portapapeles
                                        </button>
                                        <button
                                            onClick={resetSettings}
                                            className="w-full bg-gray-500 text-white py-3 px-6 rounded-xl font-medium hover:bg-gray-600 transition-all flex items-center justify-center gap-2"
                                        >
                                            üîÑ Restablecer
                                        </button>
                                    </div>
                                </div>

                                {/* Informaci√≥n mejorada */}
                                <div className="bg-white rounded-2xl p-6 shadow-lg">
                                    <h3 className="text-lg font-semibold mb-4">‚ÑπÔ∏è Informaci√≥n</h3>
                                    <div className="space-y-2 text-sm">
                                        <div className="flex justify-between">
                                            <span>Tama√±o:</span>
                                            <span className="font-medium">{iconSize}x{iconSize}px</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span>Formato:</span>
                                            <span className="font-medium">PNG</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span>Fondo:</span>
                                            <span className="font-medium">Personalizable</span>
                                        </div>
                                        {selectedTemplate && (
                                            <div className="flex justify-between">
                                                <span>Plantilla:</span>
                                                <span className="font-medium">{templates.find(t => t.id === selectedTemplate)?.name}</span>
                                            </div>
                                        )}
                                    </div>
                                    
                                    <div className="mt-4 p-3 bg-blue-50 rounded-lg">
                                        <p className="text-xs text-blue-700">
                                            üí° <strong>Tip:</strong> Usa el Batch Export para generar todos los tama√±os necesarios de una vez: 16px a 1024px.
                                        </p>
                                    </div>

                                    <div className="mt-4 p-3 bg-green-50 rounded-lg">
                                        <p className="text-xs text-green-700">
                                            üöÄ <strong>Novedad:</strong> Plantillas predefinidas para diferentes tipos de apps y vista previa con animaci√≥n hover.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Registrar el service worker para PWA si est√° disponible
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').catch(err => {
                    console.log('Service worker registration failed: ', err);
                });
            });
        }

        // Renderizar la aplicaci√≥n
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(PastelIconMaker));
    </script>
</body>
</html>